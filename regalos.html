<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>Regalos</title>

  <style>
    body { font-family: Arial, sans-serif; background:#fafafa; padding:30px; text-align:center; }
    h1 { color:#333; }
    #regalos { margin-top:30px; display:flex; flex-wrap:wrap; justify-content:center; gap:20px; }
    .item { border:2px solid transparent; padding:15px; width:200px; cursor:pointer; border-radius:12px;
           background:white; box-shadow:0 2px 6px rgba(0,0,0,0.1); transition:0.3s; text-align:center; }
    .item img { width:100%; height:160px; object-fit:cover; border-radius:8px; }
    .item:hover { transform:scale(1.03); box-shadow:0 4px 10px rgba(0,0,0,0.15); }
    .selected { border-color:#4CAF50; transform:scale(1.05); }
    button { margin-top:30px; padding:15px 40px; background:#4CAF50; color:white; border:none; border-radius:6px;
             font-size:16px; cursor:pointer; transition:0.2s; }
    button:hover { background:#43a047; }
    #message { margin-top:18px; color:#555; }
    .notice { background:#fff3cd; padding:12px; border-radius:8px; margin:15px auto; max-width:720px; color:#856404; }
    .error { background:#f8d7da; color:#721c24; }
  </style>
</head>
<body>

  <h1>Eleg√≠ tu regalo üéÅ</h1>

  <div id="info" class="notice" style="display:none;"></div>

  <div id="regalos">Cargando regalos...</div>

  <br>

  <button onclick="enviarSeleccion()">Enviar selecci√≥n</button>

  <div id="message"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const email = params.get("email");

    let regaloSeleccionado = null;
    let regalosLista = [];

    function showInfo(msg, isError) {
      const info = document.getElementById("info");
      info.style.display = "block";
      info.className = isError ? "notice error" : "notice";
      info.innerHTML = msg;
    }

    function showMessage(msg) {
      document.getElementById("message").innerText = msg;
    }

    google.script.run
      .withSuccessHandler(lista => {
        if (!Array.isArray(lista) || lista.length === 0) {
          document.getElementById("regalos").innerHTML = "<p>No hay regalos disponibles.</p>";
          return;
        }
        regalosLista = lista;
        renderRegalos(lista);
      })
      .withFailureHandler(err => {
        console.error("Error:", err);
        showInfo("Error al cargar los regalos.", true);
      })
      .getRegalos();

    function renderRegalos(lista) {
      const cont = document.getElementById("regalos");
      cont.innerHTML = "";
      lista.forEach(reg => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <img src="${reg.imagen}" alt="Regalo">
          <h3>${reg.nombre}</h3>
          <p>${reg.descripcion}</p>
        `;
        div.onclick = () => seleccionar(div, reg.id);
        cont.appendChild(div);
      });
    }

    function seleccionar(element, id) {
      document.querySelectorAll(".item").forEach(e => e.classList.remove("selected"));
      element.classList.add("selected");
      regaloSeleccionado = id;
      showMessage("");
    }

    function enviarSeleccion() {
      if (!regaloSeleccionado) {
        showMessage("Por favor eleg√≠ un regalo.");
        return;
      }

      if (!email) {
        showInfo("No se detect√≥ email en la URL.", true);
        return;
      }

      showMessage("Enviando...");

      google.script.run
        .withSuccessHandler(res => {
          if (res.success) window.location.href = "exit.html";
          else showInfo("Error: " + res.error, true);
        })
        .withFailureHandler(err => {
          showInfo("Fallo al comunicarse con el servidor.", true);
        })
        .guardarRespuesta(email, [regaloSeleccionado]);
    }
  </script>

</body>
</html>
